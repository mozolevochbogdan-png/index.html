<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultra Tier Maker</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–∂–∞—Ç–∏—è URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <style>
        :root { --bg: #000; --card: #1c1c1e; --accent: #32d74b; --text: #fff; --border: #38383a; --blue: #0a84ff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 10px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        .box { background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 15px; }
        input[type="text"] { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; width: 100%; transition: 0.2s; margin-top: 5px; }
        .btn:active { transform: scale(0.96); }
        .btn-green { background: var(--accent); color: #000; }
        .btn-blue { background: var(--blue); color: #fff; }
        .btn-gray { background: #2c2c2e; color: #fff; border: 1px dashed #555; }
        
        /* –î–æ—Å–∫–∞ */
        .tier-board { background: #000; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; width: 100%; }
        .tier-row { display: flex; min-height: 80px; border-bottom: 1px solid var(--border); }
        .tier-label { width: 65px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; text-align: center; font-size: 12px; padding: 5px; cursor: pointer; word-break: break-word; }
        .tier-content { flex: 1; background: #121212; display: flex; flex-wrap: wrap; gap: 4px; padding: 6px; min-height: 80px; align-content: flex-start; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card { width: 65px; height: 65px; position: relative; border-radius: 4px; overflow: hidden; border: 1px solid #333; flex-shrink: 0; cursor: pointer; background: #222; }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card span { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; font-size: 8px; text-align: center; padding: 2px; font-weight: bold; white-space: nowrap; overflow: hidden; }
        .card.selected { border: 3px solid var(--accent); transform: scale(1.05); z-index: 10; box-shadow: 0 0 15px var(--accent); }

        /* –ü—Ä–µ–≤—å—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ */
        .pre-card { width: 80px; display: flex; flex-direction: column; gap: 5px; background: #2c2c2e; padding: 5px; border-radius: 8px; position: relative; }
        .pre-card img { width: 100%; height: 70px; object-fit: cover; border-radius: 4px; background: #000; }
        .pre-card input { font-size: 10px; padding: 4px; margin: 0; }
        .del-btn { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: #fff; border-radius: 50%; width: 20px; height: 20px; border: none; font-size: 12px; cursor: pointer; z-index: 2; }

        /* –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏–≥—Ä—ã */
        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(15px); padding: 10px 20px; border-radius: 40px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .deck-btn { width: 50px; height: 65px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; cursor: pointer; font-size: 24px; }
        .slot { width: 65px; height: 65px; border: 2px dashed #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #000; }

        .c0 { background: #ff3b30; } .c1 { background: #ff9500; } .c2 { background: #ffcc00; }
        .c3 { background: #34c759; } .c4 { background: #007aff; } .c5 { background: #af52de; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .modal img { max-width: 80%; max-height: 60vh; border-radius: 12px; border: 2px solid #fff; }
        
        #editor, #game, #result { display: none; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 12px 24px; border-radius: 20px; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; max-width: 80%; }
        
        .url-input-group { display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- –†–ï–î–ê–ö–¢–û–† -->
<div id="editor" style="display: block;">
    <div class="box">
        <h2 style="margin-top:0">1. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
        <input type="text" id="titleInp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏—Ä-–ª–∏—Å—Ç–∞">
        <div id="tiersEdit"></div>
        <button class="btn btn-gray" onclick="addTier()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∏—Ä</button>
    </div>
    
    <div class="box">
        <h2>2. –ö–∞—Ä—Ç–æ—á–∫–∏</h2>
        <p style="font-size:12px; color:#888; margin-top:-10px;">–î–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏.</p>
        
        <div class="url-input-group">
            <input type="text" id="urlInp" placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (https://...)" style="margin-bottom:0">
            <button class="btn btn-gray" style="width: auto; margin:0;" onclick="addFromUrl()">OK</button>
        </div>
        <div style="text-align:center; margin: 10px 0; color:#555; font-size:12px;">–ò–õ–ò</div>
        <input type="file" id="fileInp" multiple accept="image/*" style="display:none">
        <button class="btn btn-gray" style="color:var(--accent)" onclick="document.getElementById('fileInp').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        
        <div id="previewArea" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px;"></div>
    </div>
    <button class="btn btn-green" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
</div>

<!-- –ò–ì–†–ê -->
<div id="game">
    <div style="padding: 10px; text-align: center;">
        <button class="btn btn-gray" onclick="finishGame()" style="width: auto; padding: 10px 40px;">‚úÖ –ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>
    <div id="capture-board" class="tier-board">
        <h2 id="boardTitle" style="text-align:center; padding:15px; margin:0;"></h2>
        <div id="rowsArea"></div>
    </div>
    <div class="controls">
        <div id="deckCount" style="font-weight:900;">0</div>
        <div class="deck-btn" onclick="openNext()">+</div>
        <div class="slot" id="mainSlot"></div>
    </div>
</div>

<!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
<div id="result">
    <div class="box">
        <button class="btn btn-green" onclick="downloadPNG()">üíæ –°–ö–ê–ß–ê–¢–¨ PNG</button>
        <button class="btn btn-blue" onclick="shareLink()">üîó –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
        <button class="btn btn-gray" style="margin-top:10px" onclick="location.href=location.origin + location.pathname">üîÑ –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô</button>
    </div>
    <div id="final-board" class="tier-board">
        <h2 id="finalTitle" style="text-align:center; padding:15px; margin:0;"></h2>
        <div id="finalRows"></div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –ö–ê–†–¢–û–ß–ö–ò -->
<div id="modal" class="modal" onclick="closeModal()">
    <img id="modalImg" src="">
    <h2 id="modalText" style="color:white; margin-top:20px;"></h2>
    <p style="color:#888;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å</p>
</div>

<script>
    let config = { title: "", tiers: ["S", "A", "B", "C"], cards: [] };
    let currentDeck = [];
    let selectedElement = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get('data');
        if (data) {
            loadSharedBoard(data);
        } else {
            renderTiers();
        }
    };

    function showToast(m, bg) {
        const t = document.getElementById('toast'); 
        t.innerText = m;
        t.style.background = bg || 'var(--accent)';
        t.style.display='block'; 
        setTimeout(()=>t.style.display='none', 3000);
    }

    // --- –†–ï–î–ê–ö–¢–û–† ---
    function renderTiers() {
        const area = document.getElementById('tiersEdit'); area.innerHTML = '';
        config.tiers.forEach((t, i) => {
            const d = document.createElement('div');
            d.style.display='flex'; d.style.gap='5px'; d.style.marginBottom='5px';
            d.innerHTML = `<input type="text" value="${t}" oninput="config.tiers[${i}]=this.value">
                           <button class="btn btn-gray" style="width:45px; height:42px;" onclick="config.tiers.splice(${i},1);renderTiers()">‚úï</button>`;
            area.appendChild(d);
        });
    }
    function addTier() { config.tiers.push("New"); renderTiers(); }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (Local)
    document.getElementById('fileInp').onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                addCardToConfig(ev.target.result, "");
            };
            reader.readAsDataURL(file);
        });
    };

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (URL)
    function addFromUrl() {
        const inp = document.getElementById('urlInp');
        const url = inp.value.trim();
        if(url) {
            addCardToConfig(url, "");
            inp.value = '';
        }
    }

    function addCardToConfig(src, text) {
        config.cards.push({ src, text });
        renderPreview();
    }

    function renderPreview() {
        const area = document.getElementById('previewArea'); area.innerHTML = '';
        config.cards.forEach((c, i) => {
            const d = document.createElement('div'); d.className = 'pre-card';
            d.innerHTML = `
                <button class="del-btn" onclick="config.cards.splice(${i},1);renderPreview()">‚úï</button>
                <img src="${c.src}">
                <input type="text" placeholder="–ü–æ–¥–ø–∏—Å—å..." value="${c.text}" oninput="config.cards[${i}].text=this.value">
            `;
            area.appendChild(d);
        });
    }

    // --- –ò–ì–†–ê ---
    function startGame() {
        if(!config.cards.length) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É!");
        config.title = document.getElementById('titleInp').value || "Tier List";
        
        document.getElementById('editor').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById('boardTitle').innerText = config.title;
        
        const area = document.getElementById('rowsArea'); area.innerHTML = '';
        config.tiers.forEach((t, i) => {
            const row = document.createElement('div'); row.className = 'tier-row';
            row.dataset.label = t; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Ç–∏—Ä–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            row.onclick = () => { if(selectedElement) placeInTier(row.querySelector('.tier-content')); };
            row.innerHTML = `<div class="tier-label c${i%6}">${t}</div><div class="tier-content"></div>`;
            area.appendChild(row);
        });
        currentDeck = [...config.cards];
        document.getElementById('deckCount').innerText = currentDeck.length;
    }

    let activeCardData = null;
    function openNext() {
        if(!currentDeck.length) return showToast("–ö–æ–ª–æ–¥–∞ –ø—É—Å—Ç–∞!");
        activeCardData = currentDeck.shift();
        document.getElementById('deckCount').innerText = currentDeck.length;
        document.getElementById('modalImg').src = activeCardData.src;
        document.getElementById('modalText').innerText = activeCardData.text;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        const slot = document.getElementById('mainSlot');
        slot.innerHTML = '';
        const card = createCardElement(activeCardData.src, activeCardData.text);
        card.classList.add('selected');
        card.onclick = (e) => { e.stopPropagation(); selectCard(card); };
        slot.appendChild(card);
        selectedElement = card;
    }

    function createCardElement(src, text) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<img src="${src}"><span>${text}</span>`;
        return card;
    }

    function selectCard(el) {
        if(selectedElement) selectedElement.classList.remove('selected');
        selectedElement = el; el.classList.add('selected');
    }

    function placeInTier(content) {
        selectedElement.classList.remove('selected');
        const el = selectedElement;
        content.appendChild(el);
        el.onclick = (e) => { e.stopPropagation(); selectCard(el); };
        selectedElement = null;
    }

    function finishGame() {
        document.getElementById('game').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('finalTitle').innerText = config.title;
        document.getElementById('finalRows').innerHTML = document.getElementById('rowsArea').innerHTML;
        
        // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–∞—Ç—å –≤ —Ñ–∏–Ω–∞–ª–µ
        const cards = document.getElementById('finalRows').querySelectorAll('.card');
        cards.forEach(c => c.onclick = null);
    }

    // --- –≠–ö–°–ü–û–†–¢ / –ò–ú–ü–û–†–¢ ---

    async function downloadPNG() {
        showToast("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏...");
        const canvas = await html2canvas(document.getElementById('final-board'), { backgroundColor: '#000', scale: 2, useCORS: true });
        const link = document.createElement('a');
        link.download = `tier-list-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }

    function shareLink() {
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        const title = document.getElementById('finalTitle').innerText;
        const tiersData = [];
        
        const rows = document.getElementById('finalRows').querySelectorAll('.tier-row');
        rows.forEach(row => {
            const label = row.querySelector('.tier-label').innerText;
            const cards = [];
            row.querySelectorAll('.card').forEach(c => {
                cards.push({
                    s: c.querySelector('img').getAttribute('src'),
                    t: c.querySelector('span').innerText
                });
            });
            tiersData.push({ l: label, c: cards });
        });

        const shareObj = { title: title, data: tiersData };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ (Base64)
        const jsonStr = JSON.stringify(shareObj);
        if(jsonStr.length > 20000) {
             showToast("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–æ–≤.", "#ff3b30");
        }

        const compressed = LZString.compressToEncodedURIComponent(jsonStr);
        const url = `${window.location.origin}${window.location.pathname}?data=${compressed}`;
        
        navigator.clipboard.writeText(url).then(() => {
            showToast("üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
        }).catch(() => {
            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:", url);
        });
    }

    function loadSharedBoard(compressed) {
        try {
            const decompressed = LZString.decompressFromEncodedURIComponent(compressed);
            if(!decompressed) throw new Error("Empty data");
            const obj = JSON.parse(decompressed);

            // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('editor').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('finalTitle').innerText = obj.title;
            
            const area = document.getElementById('finalRows');
            area.innerHTML = '';
            
            obj.data.forEach((tier, i) => {
                const row = document.createElement('div'); row.className = 'tier-row';
                let cardsHtml = '';
                tier.c.forEach(card => {
                    cardsHtml += `<div class="card"><img src="${card.s}"><span>${card.t}</span></div>`;
                });
                
                row.innerHTML = `<div class="tier-label c${i%6}">${tier.l}</div>
                                 <div class="tier-content">${cardsHtml}</div>`;
                area.appendChild(row);
            });

        } catch(e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±–∏—Ç–∞—è.");
            window.location.href = window.location.pathname;
        }
    }
</script>
</body>
</html>
